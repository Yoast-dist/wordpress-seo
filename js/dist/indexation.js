(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,n=window.jQuery;var s=e.n(n);const r=window.wp.i18n,i=window.yoast.componentsNew,o=window.yoast.styleGuide,a=window.yoast.propTypes;var d=e.n(a);const l=window.yoast.helpers,c=window.yoast.styledComponents;var p=e.n(c);class u extends Error{constructor(e,t,n,s,r){super(e),this.name="RequestError",this.url=t,this.method=n,this.statusCode=s,this.stackTrace=r}}const{stripTagsFromHtmlString:g}=l.strings,h=["a","p"],m=p().div`
	margin-top: 8px;
`,w=p().pre`
	overflow-x: scroll;
	max-width: 500px;
	border: 1px solid;
	padding: 16px;
`;function x({title:e,value:n}){return n?(0,t.createElement)("p",null,(0,t.createElement)("strong",null,e),(0,t.createElement)("br",null),n):null}function y({title:e,value:n}){return n?(0,t.createElement)("details",null,(0,t.createElement)("summary",null,e),(0,t.createElement)(w,null,n)):null}function E({message:e,error:n}){return(0,t.createElement)(i.Alert,{type:"error"},(0,t.createElement)("div",{dangerouslySetInnerHTML:{__html:g(e,h)}}),(0,t.createElement)("details",null,(0,t.createElement)("summary",null,(0,r.__)("Error details","wordpress-seo")),(0,t.createElement)(m,null,(0,t.createElement)(x,{title:(0,r.__)("Request URL","wordpress-seo"),value:n.url}),(0,t.createElement)(x,{title:(0,r.__)("Request method","wordpress-seo"),value:n.method}),(0,t.createElement)(x,{title:(0,r.__)("Status code","wordpress-seo"),value:n.statusCode}),(0,t.createElement)(x,{title:(0,r.__)("Error message","wordpress-seo"),value:n.message}),(0,t.createElement)(y,{title:(0,r.__)("Response","wordpress-seo"),value:n.parseString}),(0,t.createElement)(y,{title:(0,r.__)("Error stack trace","wordpress-seo"),value:n.stackTrace}))))}x.propTypes={title:d().string.isRequired,value:d().any},x.defaultProps={value:""},y.propTypes={title:d().string.isRequired,value:d().string},y.defaultProps={value:""},E.propTypes={message:d().string.isRequired,error:d().oneOfType([d().instanceOf(Error),d().instanceOf(u)]).isRequired};class S extends Error{constructor(e,t){super(e),this.name="ParseError",this.parseString=t}}const f="idle",_="in_progress",I="errored",A="completed";class v extends t.Component{constructor(e){super(e),this.settings=yoastIndexingData,this.state={state:f,processed:0,error:null,amount:parseInt(this.settings.amount,10),firstTime:"1"===this.settings.firstTime},this.startIndexing=this.startIndexing.bind(this),this.stopIndexing=this.stopIndexing.bind(this)}async doIndexingRequest(e,t){const n=await fetch(e,{method:"POST",headers:{"X-WP-Nonce":t}}),s=await n.text();let r;try{r=JSON.parse(s)}catch(e){throw new S("Error parsing the response to JSON.",s)}if(!n.ok){const t=r.data?r.data.stackTrace:"";throw new u(r.message,e,"POST",n.status,t)}return r}async doPreIndexingAction(e){"function"==typeof this.props.preIndexingActions[e]&&await this.props.preIndexingActions[e](this.settings)}async doPostIndexingAction(e,t){"function"==typeof this.props.indexingActions[e]&&await this.props.indexingActions[e](t.objects,this.settings)}async doIndexing(e){let n=this.settings.restApi.root+this.settings.restApi.indexing_endpoints[e];for(;this.isState(_)&&!1!==n;)try{await this.doPreIndexingAction(e);const s=await this.doIndexingRequest(n,this.settings.restApi.nonce);await this.doPostIndexingAction(e,s),(0,t.flushSync)((()=>{this.setState((e=>({processed:e.processed+s.objects.length,firstTime:!1})))})),n=s.next_url}catch(e){(0,t.flushSync)((()=>{this.setState({state:I,error:e,firstTime:!1})}))}}async index(){for(const e of Object.keys(this.settings.restApi.indexing_endpoints))await this.doIndexing(e);this.isState(I)||this.isState(f)||this.completeIndexing()}async startIndexing(){this.setState({processed:0,state:_},this.index)}completeIndexing(){this.setState({state:A})}stopIndexing(){this.setState((e=>({state:f,processed:0,amount:e.amount-e.processed})))}componentDidMount(){var e,t;if(!this.settings.disabled&&(this.props.indexingStateCallback(0===this.state.amount?"completed":this.state.state),"true"===new URLSearchParams(window.location.search).get("start-indexation"))){const n=function(e,t){const n=new URL(e);return n.searchParams.delete("start-indexation"),n.href}(window.location.href);null,e=document.title,t=n,window.history.pushState(null,e,t),this.startIndexing()}}componentDidUpdate(e,t){this.state.state!==t.state&&this.props.indexingStateCallback(this.state.state)}isState(e){return this.state.state===e}renderFirstIndexationNotice(){return(0,t.createElement)(i.Alert,{type:"info"},(0,r.__)("This feature includes and replaces the Text Link Counter and Internal Linking Analysis","wordpress-seo"))}renderStartButton(){return(0,t.createElement)(i.NewButton,{variant:"primary",onClick:this.startIndexing},(0,r.__)("Start SEO data optimization","wordpress-seo"))}renderStopButton(){return(0,t.createElement)(i.NewButton,{variant:"secondary",onClick:this.stopIndexing},(0,r.__)("Stop SEO data optimization","wordpress-seo"))}renderDisabledTool(){return(0,t.createElement)(t.Fragment,null,(0,t.createElement)("p",null,(0,t.createElement)(i.NewButton,{variant:"secondary",disabled:!0},(0,r.__)("Start SEO data optimization","wordpress-seo"))),(0,t.createElement)(i.Alert,{type:"info"},(0,r.__)("SEO data optimization is disabled for non-production environments.","wordpress-seo")))}renderProgressBar(){return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(i.ProgressBar,{style:{height:"16px",margin:"8px 0"},progressColor:o.colors.$color_pink_dark,max:parseInt(this.state.amount,10),value:this.state.processed}),(0,t.createElement)("p",{style:{color:o.colors.$palette_grey_text}},(0,r.__)("Optimizing SEO data... This may take a while.","wordpress-seo")))}renderErrorAlert(){return(0,t.createElement)(E,{message:yoastIndexingData.errorMessage,error:this.state.error})}renderTool(){return(0,t.createElement)(t.Fragment,null,this.isState(_)&&this.renderProgressBar(),this.isState(I)&&this.renderErrorAlert(),this.isState(f)&&this.state.firstTime&&this.renderFirstIndexationNotice(),this.isState(_)?this.renderStopButton():this.renderStartButton())}render(){return this.settings.disabled?this.renderDisabledTool():this.isState(A)||0===this.state.amount?(0,t.createElement)(i.Alert,{type:"success"},(0,r.__)("SEO data optimization complete","wordpress-seo")):this.renderTool()}}v.propTypes={indexingActions:d().object,preIndexingActions:d().object,indexingStateCallback:d().func},v.defaultProps={indexingActions:{},preIndexingActions:{},indexingStateCallback:()=>{}};const T=v;let b;function P(){b||(b=document.getElementById("yoast-seo-indexing-action")),b&&(0,t.render)((0,t.createElement)(T,{preIndexingActions:window.yoast.indexing.preIndexingActions,indexingActions:window.yoast.indexing.indexingActions}),b)}window.yoast=window.yoast||{},window.yoast.indexing=window.yoast.indexing||{},window.yoast.indexing.preIndexingActions={},window.yoast.indexing.indexingActions={},window.yoast.indexing.registerPreIndexingAction=(e,t)=>{window.yoast.indexing.preIndexingActions[e]=t,P()},window.yoast.indexing.registerIndexingAction=(e,t)=>{window.yoast.indexing.indexingActions[e]=t,P()},s()((function(){P()}))})();